#!/bin/bash

usage()
{
    cat << EOT
Usage:
    save           Push conf changes to omnimike/conf
    load           Pull conf changes from omnimike/conf
    status         Show changes to conf
    install        Install everything
    install-subl   Install sublime text config
    install-vim    Install the ~/.vimrc file and vim-plug
    install-bin    Install this script to ~/bin
    install-zsh    Install zsh scripts to ~/.oh-my-zsh/custom
    install-osx    Set OSX settings
EOT
}

# SOURCE_FILE is the full path to this file
# CONF_DIR is the full path to the root folder of the conf repository
SOURCE_FILE="${BASH_SOURCE}"
if [ -L $SOURCE_FILE ]; then
    SOURCE_FILE="$( readlink $SOURCE_FILE )"
fi
CONF_DIR="$( cd "$( dirname "$SOURCE_FILE" )" && pwd )"/..

die()
{
    echo "$@" >&2
    exit 1
}

save()
{
    git -C $CONF_DIR add -f . || die
    git -C $CONF_DIR commit -m "save" || die
    git -C $CONF_DIR push || die
}

load()
{
    git -C $CONF_DIR pull
}

status()
{
    git -C $CONF_DIR status
}

install_all()
{
    install_sublime
    install_vim
    install_bin
    install_zsh
    install_osx
}

install_sublime()
{
    ln -svf $CONF_DIR/subl/* $HOME/Library/Application\ Support/Sublime\ Text\ 3/Packages/User
}

install_vim()
{
    # Link .vimrc
    ln -svf $CONF_DIR/vim/init.vim $HOME/.vimrc
    # Install vim-plug
    curl -fLo $HOME/.vim/autoload/plug.vim --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    # Create the swapfile folder
    mkdir -p $HOME/.vim/backup
    mkdir -p $HOME/.vim/swapfiles
    mkdir -p $HOME/.vim/undo
}

install_bin()
{
    # Make the bin folder
    mkdir -p $HOME/bin || die "Couldn't create ~/bin"
    # Link all of the scripts
    ln -svf $CONF_DIR/bin/* $HOME/bin
}

install_zsh()
{
    ln -svf $CONF_DIR/zsh/init.zsh $HOME/.zshrc
    # Scripts in the custom folder will be automatically loaded
}

install_osx()
{
    defaults write -g ApplePressAndHoldEnabled -bool false
}

case $1 in
    save) save
        ;;
    load) load
        ;;
    status) status
        ;;
    install) install_all
        ;;
    install-subl) install_sublime
        ;;
    install-vim) install_vim
        ;;
    install-bin) install_bin
        ;;
    install-zsh) install_zsh
        ;;
    install-osx) install_osx
        ;;
    -h | help | --help) usage
        ;;
    *) usage
        die
        ;;
esac
